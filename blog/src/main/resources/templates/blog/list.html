<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Danh s√°ch Blog (AJAX)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #message {
            display: none;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        #message.success { background-color: #d4edda; color: #155724; }
        #message.error   { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-3">üìù Danh s√°ch Blog (AJAX)</h2>

    <form onsubmit="event.preventDefault(); searchBlogs();" class="row g-2 mb-3">
        <div class="col-md-6">
            <input type="text" id="keyword" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a m√¥ t·∫£ ho·∫∑c n·ªôi dung">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">üîç T√¨m ki·∫øm</button>
        </div>
        <div class="col-md-4 text-end">
            <a href="/blog/create" class="btn btn-success">‚ûï Th√™m Blog m·ªõi</a>
        </div>
    </form>

    <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Ng√†y ƒëƒÉng</th>
            <th>M√¥ t·∫£</th>
            <th>N·ªôi dung</th>
            <th>Th·ªÉ lo·∫°i</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="blogTableBody">
        </tbody>
    </table>

    <nav>
        <ul class="pagination" id="pagination">

        </ul>
    </nav>

    <p id="message"></p>
</div>

<script>
    let currentPage = 0;
    let currentKeyword = "";

    function loadBlogs(page = 0, keyword = "") {
        currentPage = page;
        let url = `/api/blog?page=${page}`;
        if (keyword) url += `&keyword=${keyword}`;

        fetch(url)
            .then(res => {
                if (res.status === 204) {
                    renderTable([], 0, 0);
                    showMessage(" Kh√¥ng c√≥ blog n√†o", "error");
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;
                if (Array.isArray(data)) {
                    renderTable(data, 0, 1);
                } else {
                    renderTable(data.content, data.number, data.totalPages);
                }
            })
            .catch(err => showMessage("L·ªói khi t·∫£i d·ªØ li·ªáu: " + err, "error"));
    }

    function renderTable(blogs, page, totalPages) {
        const tbody = document.getElementById("blogTableBody");
        tbody.innerHTML = "";

        if (blogs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-muted">‚ö†Ô∏è Kh√¥ng c√≥ blog n√†o</td></tr>`;
            return;
        }

        blogs.forEach(blog => {
            tbody.innerHTML += `
                <tr id="row-${blog.id_blog}">
                    <td>${blog.id_blog}</td>
                    <td>${blog.date ? new Date(blog.date).toLocaleDateString() : ""}</td>
                    <td>${blog.describe}</td>
                    <td>${blog.context}</td>
                    <td>${blog.category ? blog.category.name : ""}</td>
                    <td>
                        <a href="/blog/${blog.id_blog}" class="btn btn-info btn-sm">üìñ Chi ti·∫øt</a>
                        <a href="/blog/update/${blog.id_blog}" class="btn btn-warning btn-sm">‚úèÔ∏è S·ª≠a</a>
                        <button class="btn btn-danger btn-sm" onclick="deleteBlog(${blog.id_blog})">üóëÔ∏è X√≥a</button>
                    </td>
                </tr>
            `;
        });

        renderPagination(page, totalPages);
    }

    function renderPagination(page, totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        pagination.innerHTML += `
            <li class="page-item ${page === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadBlogs(${page - 1}, currentKeyword)">&laquo;</a>
            </li>
        `;

        for (let i = 0; i < totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadBlogs(${i}, currentKeyword)">${i + 1}</a>
                </li>
            `;
        }

        pagination.innerHTML += `
            <li class="page-item ${page === totalPages - 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadBlogs(${page + 1}, currentKeyword)">&raquo;</a>
            </li>
        `;
    }

    function deleteBlog(id) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a blog n√†y?")) {
            fetch(`/api/blog/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.status === 204) {
                        document.getElementById("row-" + id).remove();
                        showMessage(" X√≥a blog th√†nh c√¥ng", "success");
                    } else {
                        showMessage("Kh√¥ng t√¨m th·∫•y blog ƒë·ªÉ x√≥a", "error");
                    }
                })
                .catch(err => showMessage("L·ªói khi g·ªçi API: " + err, "error"));
        }
    }

    function searchBlogs() {
        currentKeyword = document.getElementById("keyword").value;
        loadBlogs(0, currentKeyword);
    }

    function showMessage(msg, type) {
        const el = document.getElementById("message");
        el.innerText = msg;
        el.className = type;
        el.style.display = "block";
        setTimeout(() => el.style.display = "none", 3000);
    }

    document.addEventListener("DOMContentLoaded", () => loadBlogs(0));
</script>
</body>
</html>
